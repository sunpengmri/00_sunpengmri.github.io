# 医学影像数据如何为机器学习做好准备：从数据准备到未来展望



在医学影像领域，人工智能（AI）的应用潜力巨大，从图像生成到诊断再到预后预测，几乎涵盖了整个医学影像生命周期。然而，AI 算法的开发和临床应用面临着巨大挑战，其中最主要的障碍之一就是缺乏足够大、经过精心整理且具有代表性的训练数据，包括专家标注（如注释）。当前，大多数研究团队和行业机构只能获取有限的数据，这些数据往往来自小样本量和小地理区域，导致开发出的算法实用性有限且泛化能力差。本文将深入探讨为 AI 算法开发准备医学影像数据的基本步骤，解释当前数据整理的局限性，并探索解决数据可用性问题的新方法。

![alt text](image.png)
<div style="text-align:center;">
图一 机器学习数据准备整体流程
</div>

## 一、数据准备概述



在将医学影像用于 AI 算法开发之前，需要采取一系列关键步骤。通常，在将医学数据用于研究或商业 AI 算法开发之前，需要获得当地伦理委员会的批准。机构审查委员会需要评估研究对患者的风险和益处。在许多情况下，会使用现有数据，这需要进行回顾性研究。由于这类研究中的患者不需要接受任何额外的程序，通常可以免除明确的知情同意。而在临床试验中，每位主要研究者可能需要提供批准才能分享其参与者的数据。对于前瞻性研究，即前瞻性收集研究数据的情况，则需要获得知情同意。


获得伦理批准后，需要访问、查询相关数据，并对其进行适当的去标识化和安全存储。任何受保护的健康信息都需要从数字成像和通信医学（DICOM）元数据以及图像中移除。如果数据用于开源研究，通常需要对每张图像进行人工检查，因为有些图像包含扫描的自由格式注释，这些注释无法通过自动化方法可靠移除。图像的质量和数量因目标任务和领域而异。接下来的步骤是将数据构建为同质化且机器可读的格式。最后一步是将图像与 ground truth 信息链接起来，这些信息可以是一个或多个标签、分割或电子表型（如活检或实验室结果）。


## 二、数据访问与查询



AI 算法开发者通常不在医院内，因此往往无法直接通过图像存档和通信系统（PACS）访问医学影像数据，尤其是在开发商业算法时。PACS 环境的访问仅限于经认可的专业人员，如医生、技术人员、PACS 管理人员和临床科学家。使数据对 AI 开发者可用是一项具有挑战性的任务，需要多个步骤，包括数据去标识化。理想的方法是临床医生和 AI 开发者之间的合作，无论是内部合作还是通过合作研究协议。


一旦 AI 开发者可以访问数据，就可以使用不同的策略来搜索医学影像和临床数据。自定义搜索查询可能包括字符串、国际疾病分类代码和当前操作术语代码。可以使用 PACS 或放射学信息系统搜索引擎从医院 PACS 和电子病历中系统地搜索和提取数据。例如，许多 PACS 供应商允许用户访问元数据，如注释、创建者、系列和图像编号，以及唯一的目标病变名称和关系。这些数据可以在某些 PACS 中导出，并由其他系统进一步管理，如电子病历、癌症数据库和肿瘤学家或其他提供者数据库。此外，还有软件包可用于简化数据查询过程。


## 三、数据去标识化



根据美国《健康保险流通与责任法案》（HIPAA）和欧洲《通用数据保护条例》（GDPR），无论是回顾性还是前瞻性收集的数据，都需要进行适当的去标识化，尽管并非总是需要患者的书面知情同意。敏感信息包括但不限于姓名、医疗记录号和出生日期。HIPAA 规定的 18 个标识符完整列表如下表所示：




| 类别&#xA;     | 具体标识符&#xA;                                              |
| ----------- | ------------------------------------------------------- |
| 个人识别信息&#xA; | 姓名、别名、地址（除州外的详细地址）、电话号码、传真号码、电子邮件地址&#xA;                |
| 日期信息&#xA;   | 出生日期、入院日期、出院日期、死亡日期，以及任何与上述日期相关的年龄（超过 89 岁）&#xA;        |
| 身份标识&#xA;   | 医疗记录号、健康计划受益人编号、账户号、证书 / 许可证编号、车辆标识符及序列号、设备标识符及序列号&#xA; |
| 生物特征标识&#xA; | 指纹、视网膜扫描、面部照片等&#xA;                                     |
| 其他标识&#xA;   | 社会安全号码、驾照号码、护照号码、任何唯一的个人标识符、全脸照片和可比图像&#xA;              |

可识别信息通常存在于 DICOM 元数据（标头）中，有多种工具可用于自动移除这些信息。DICOM 去标识化配置文件是为一系列应用定义的，并用作北美放射学会临床试验处理器和癌症影像档案中实施的去标识化工作流程的基础。除了 DICOM 元数据外，受保护的健康信息还可能嵌入在图像中，这在超声检查或扫描到医疗系统中的放射照片中很常见。移除嵌入信息需要更高级的去标识化方法，如光学字符识别和人工审查，因为扫描图像上的手写内容通常无法被自动化方法识别。还必须注意不要无意中混合数据集，因为这样会增加通过非相关数据点的交叉链接重新识别个人的风险。最后，医疗数据可以使用 k - 匿名化进行匿名化，这会转换包含受保护健康信息的原始数据集，以防止潜在的入侵者确定患者的身份。对于在开源研究工作中发布放射学数据，DICOM 元数据通常会被完全移除或转换为其他格式，如神经影像信息学技术倡议（NIFTI），该格式仅保留体素大小和患者位置。


## 四、数据存储



数据通常传输到本地数据存储（单中心研究）或外部数据存储（多中心研究或商业 AI 开发）。数据通常存储在本地服务器上；然而，随着当前基于云的发展，数据越来越多地存储在云中。本地数据存储的优点包括数据安全性和可用性，但与其他机构共享数据的可能性有限。另一方面，基于云的数据存储变得越来越安全，提高了共享数据的可能性，并提供了数据备份。云存储的缺点包括成本和对快速互联网连接的需求。


## 五、医学图像重采样



与非医学图像感知任务相比，医学图像数据的图像感知相对复杂。大多数用于图像分类的卷积神经网络在训练和测试时使用的是小于 300×300 像素的二维图像。然而，医学图像的尺寸超过了这些维度；平面内空间分辨率通常高于 300×300 像素，并且许多医学图像研究是三维的而不是二维的。使用大于 300×300 像素的图像训练卷积神经网络是可能的，但需要具有强大计算能力的计算机。这个问题在高分辨率应用中最为相关，例如内耳 CT 或全视野数字化乳腺 X 线摄影。解决方案包括下采样图像分辨率或仅对包含相关信息的图像部分进行基于块的评估（例如，在为主动脉夹层分割开发的算法中专注于主动脉区域）。然而，基于块的方法通常具有高计算需求且训练耗时。模型训练也可以通过将标签分类为健康（0 级）和不同程度的疾病来简化；例如，从轻度疾病（2 级）到重度疾病（4 级）。


除了包含元数据和图像切片的 DICOM 文件外，还有其他文件类型可用。使用原始 MRI 或 CT 数据（在图像重建之前）进行 AI 开发越来越受关注，并具有潜在的重要作用。优点包括原始数据中捕获的信息量增加，缺点包括需要大量存储空间以及没有重建图像时难以解释原始数据。


## 六、选择合适的标签和 ground truth 定义



当前用于医学图像分类任务的 AI 算法通常基于监督学习方法。这意味着在训练和测试 AI 算法之前，需要定义 ground truth 并将其与图像链接。“ground truth” 一词通常指从直接观察（如活检或实验室结果）获得的信息。图像标签是由放射科医生等医学专家进行的注释。如果成像作为参考标准（如气胸），这些注释可以被视为 ground truth。为给定的成像 AI 应用选择合适的标签需要在找到最佳区分类别（如正常与紧急）和临床相关的粒度（如肝病变亚型）之间取得平衡，这取决于所需的任务。除了增强图像质量的 AI 方法外，孤立的医学图像通常不适合开发诊断 AI 模型，除非通过自由文本放射学报告（需要下面讨论的额外标记策略）、专家共识、分割或应用的 ground truth 标签（如电子表型）与诊断相关联。


虽然通过自然语言处理从放射学报告文本中提取结构化标签可能最终是最具可扩展性的方法，但研究人员需要注意自然语言处理技术和原始文本报告中的错误率。众所周知，在大量数据中，AI 算法可以在相对低质量的数据上进行训练，但了解给定任务的真实 ground truth 以与成像结果相关联是理想的。对于某些诊断，仅医学成像即可视为 ground truth，包括颅内出血、骨折、肾结石和主动脉夹层。然而，大多数发现仅基于成像检查并不确定，需要进一步的随访、病理诊断或临床结果来获得 ground truth（如肺癌、肝肿块、肺炎等）。例如，胸部 X 光片上的不透光区有广泛的鉴别诊断。如果没有获得手术、病理、基因组或临床结果数据，很难知道 ground truth。


在一般情况下，成像数据可以通过多种方式进行标记，包括结构化标签、图像注释、图像分割和 / 或电子表型。更多时候，使用基于专家解释的成像诊断或基于图像重新解释的专家共识，或自由文本报告。另一种标记方法是使用分割，例如在胸部 CT 上勾勒肺结节。


## 七、ground truth 或标签质量



构建准确的医学影像 AI 模型需要大量放射学检查的准确 ground truth 定义或图像标签。有报告诊断成像的指南，旨在实现结构化报告，这将大大减少提取有用成像标签所需的工作。然而，目前绝大多数报告仍然是自由文本。旨在实时索引和编纂自由文本报告的新型语义报告系统正在开发中，但目前尚未广泛应用于大量人群。因此，大多数尝试使用回顾性数据的中心都面临着大量的成像研究和叙述性报告，需要大量的工作来标记。

![alt text](image-1.png)
<div style="text-align:center;">
图二 数据勾画
</div>

目前，有许多方法可以进行回顾性标记，从放射科医生的简单手动标记到可以从放射学报告和 / 或电子病历中提取结构化信息的自动化方法。在医学应用之外，手动标记是为 AI 应用获取标记成像数据的常用方法。大型公司经常雇佣非专家手动审查和标记支持自动化服务所需的大量数据，如网页搜索结果排名、提供推荐或显示相关广告。这种方法在医学成像中也可能有效，但在大多数情况下，当用于大量人群时是不切实际的，因为使用医学专家极其耗时（且成本高昂），特别是对于 CT、PET 或 MRI 等高级模态。当 AI 开发只需要相对少量的图像时，医学专家标记和分割可能是可行的。分割性能可以使用 Dice 系数或更先进的同时真相和性能水平估计（STAPLE）算法进行评估。STAPLE 算法比较分割并计算真实分割的概率估计。对于专注于特定领域的应用，如结肠息肉分类和肾脏分割，非专家的众包标签可能是可行的。


## 八、数据集



使用监督学习开发 AI 算法需要大型且异构的训练、验证和测试数据集。


### （一）数据集类型&#xA;

与传统回归建模类似，AI 模型通过输入与 ground truth 结果变量（如气胸）链接的医学图像进行训练。通常，训练成像数据集大于验证和测试数据集，比例为 80:10:10 或 70:15:15。为了确保 AI 算法的泛化能力，应限制训练数据集的偏差。如果 AI 算法使用来自欧洲机构的图像进行训练，而该算法用于亚洲人群，则性能可能会受到人群或疾病流行率偏差的影响。同样，如果所有成像训练数据都是使用一种成像机器获取的，那么它可能在其他制造商的机器上效果不佳，这被称为供应商或单一来源偏差。因此，建议使用来自多个不同来源的图像，或至少使用代表目标人群或算法将部署的卫生系统的图像。


算法训练完成后，需要验证数据集来微调算法超参数并检查过拟合。注意，AI 算法开发中的验证与传统统计建模中的验证具有不同的含义。在这里，验证意味着调整算法，直到使用测试数据集评估模型的最终性能。有多种内部验证方法可用；然而，为了正确评估泛化能力，外部数据集中的独立验证优于内部验证。即使有电子表型（如肺结节的活检结果），训练和验证数据集也需要注释来告知算法特定肺结节的位置，以便算法更好地理解图像。测试数据集用作参考标准，用于评估算法的性能。在多种情况下，成像是参考标准（如气胸），此时测试成像数据集需要高质量的注释，因为该数据集用作参考标准。测试数据集的质量和准确性可以说比训练集更重要，因为该数据集用于性能测试和监管批准。


### （二）数据集大小&#xA;

为了确保泛化能力，大型训练数据集通常是必不可少的。对于特定的目标应用或人群，相对较小的数据集（数百例）可能就足够了。在具有显著异质性的人群中或当成像表型之间的差异微妙时，尤其需要大样本量。计算机视觉任务的算法性能随着训练数据量的增加而呈对数增长。因此，需要适当的样本量。功效计算的主要问题包括：(a) 需要在样本中包含哪些病例，以允许在更大的人群中进行泛化，以及 (b) 需要多少病例才能显示效果。测试数据集的样本量计算应使用传统的功效计算方法来估计样本量。一般来说，在医学影像中开发可泛化的 AI 算法需要数十万或数百万的统计功效数据集，这对许多研究人员和开发人员来说是一个难题。


### （三）数据源&#xA;

医学影像中大多数学术开发的 AI 算法都是使用来自单一机构的本地数据进行训练、验证和测试的。虽然来自不同地理区域的多机构数据将包括各种各样的成像机器、种族和病理，但由于无法访问多机构数据，通常使用单一机构数据。许多医疗中心缺乏与其他机构或开发 AI 算法的公司共享数据的动机和资源，尽管通过适当的去标识化方法和安全的数据处理，医学影像数据可以在不违反 GDPR 或 HIPAA 法规的情况下共享。目前，医学影像数据存储在孤立的分散式数据孤岛中，限制了可泛化的无偏 AI 算法的开发，理论上可以通过集中式数据存储系统来解决。当数据提供给 AI 开发者时，适当的数据管理至关重要。


### （四）开源数据集&#xA;

越来越多的数据集已开源，以解决医学研究中的数据访问问题。数据集可用于从神经成像、乳腺成像、胸部 X 光片、膝盖 MRI、身体 CT 等广泛领域。尽管开源数据集刺激了医学影像领域新型 AI 算法的开发，但也存在重要限制。首先，图像的数量和质量、元数据和临床信息的可用性差异很大。其次，一些开源数据集（部分）使用过时的机器获取，包含低质量图像，缺乏专家标记或数据整理，或样本量太小，无法开发可临床使用的高质量算法。此外，许多开源数据集仅限于非商业（仅研究）用途。这对于希望开发可市场化算法的研究人员来说是一个主要限制，因为商业采用是临床部署的常见途径。


## 九、偏差



基于来自单一机构或小地理区域的多个机构的数据训练 AI 算法的最重要限制之一是采样偏差。如果以这种方式训练的 AI 算法应用于不同的地理区域，由于样本人群和目标人群之间的差异，算法的结果可能不可靠。其他偏差来源包括年龄、种族和性别比例、成像机器的使用（供应商、类型、采集协议）以及疾病流行率的差异。甚至可能存在研究人员未意识到的偏差，如当地实践的变化。


对于许多医学应用，评估图像的专家之间存在很大的可变性，这在临床实践中是真实的，因为标签和分割是手动创建的，这是固有的。这种可变性可能导致有偏差的标签和分割，通过让多个专家评估同一病例可以减轻这种情况。然而，大量成本和时间延迟通常限制了多个专家的图像评估。使用来自广泛地理区域的训练数据的另一个重要原因是为发展中国家的患者提供 AI 算法。大多数 AI 算法是由研究团队和公司开发的，这些团队和公司可以访问来自发达国家患者的训练数据集。


## 十、数据格式



与 AI 应用开发相关的两种关键格式类型是图像数据格式和图像注释格式。几乎所有 PACS 都以 DICOM 格式存储医学图像，这是图像对象的国际标准。然而，收集图像的团体可能会将它们从 DICOM 转换为其他格式，如 PNG、TIFF 或 NIFTI，以便于分发。然而，应该记住，这些转换会删除重要的 DICOM 元数据。图像转换程序非常普遍且易于访问，因此在 AI 应用开发中访问和使用从多个机构获取的图像数据通常没有问题。


与图像数据不同，图像注释没有存储在单一的通用格式中。当前获取图像注释的商业成像系统（如用于跟踪癌症病变）的一个主要限制是，它们通常不以允许重新用于 AI 开发的格式存储注释。图像注释通常作为 DICOM 表示状态对象存储在 PACS 和其他系统中，这些对象在供应商之间通常不同，并且难以从中提取感兴趣区域，并且通常这些对象不包含图像标签。即使它们使用 DICOM 结构化报告（DICOM-SR），该报告提供了用于存储图像注释详细信息的不同用例特定模板，跨系统的类似注释数据可能使用不同类型的 DICOM SR 模板存储，这阻碍了从不同站点或甚至同一站点内不同商业系统获取注释时的互操作性和重新使用。


## 十一、联邦学习



2017 年，谷歌引入了联邦学习，这是一种解决 AI 算法开发数据可用性问题的潜在方案。在当前的实践中，去标识化的数据从医院（或数据孤岛）传输到中央存储系统，而在联邦学习中，数据留在医院，算法可以在多个位置本地训练。此外，与图像数据相比，算法本身占用的存储空间要少得多。因此，跨机构分布算法训练可能是一个可行的解决方案。
![alt text](image-2.png)
<div style="text-align:center;">
图三 联邦学习
</div>

已经提出了不同的方法，包括并行和非并行训练方法。开发并行训练方法是为了通过将数据集分割成单独的样本来加速算法训练。在数据的每个分割上训练不同的模型，最后将梯度传输到中央模型。对于非并行训练，使用顺序或循环方法，其中模型使用来自每个机构的数据进行更新。联邦学习在医学影像领域尚未得到广泛评估。


尽管这项技术有潜在的好处，但在应用联邦学习之前，需要解决一些重要问题。首先，可扩展性有限，因为每个站点需要按照约定的标准进行图像注释和标记，因为数据不能离开机构。其次，可能需要

## 参考文献

Willemink M J, Koszek W A, Hardell C, et al. Preparing Medical Imaging Data for Machine Learning[J]. Radiology, 2020, 295(1): 4-15.

### 感谢关注，欢迎合作

微信：Chushanzhishi2022
微信公众号：NMR凯米小屋
作者B站：楚山之石
CSDN: 楚山之石
知乎: 楚山之石